import React, { useState, useEffect, useRef } from 'react';
import { Copy, Check, RefreshCw, Settings, BookOpen, FileText, Download, Upload, Trash2, Sun, Moon, Monitor } from 'lucide-react';

// ============================================================================
// TYPES
// ============================================================================

type DocumentType = 'audit-finding' | 'executive-summary' | 'status-update' | 'email-senior' | 'risk-description';

interface RewriteOptions {
  activeVoice: boolean;
  clearOwnership: boolean;
  sharperImpact: boolean;
  calmTone: boolean;
  concise: boolean;
  owner?: string;
  documentType: DocumentType;
}

interface Change {
  type: string;
  description: string;
}

interface RewriteResult {
  rewrittenText: string;
  changeLog: Change[];
  suggestions: string[];
}

interface StyleExample {
  id: string;
  title: string;
  text: string;
  tags: string[];
  isActive: boolean;
}

interface AppSettings {
  theme: 'light' | 'dark' | 'system';
  defaultDocType: DocumentType;
  defaultToggles: Omit<RewriteOptions, 'owner' | 'documentType'>;
}

// ============================================================================
// STORAGE LAYER
// ============================================================================

class Storage {
  private dbName = 'ClearLineDB';
  private version = 1;
  private db: IDBDatabase | null = null;

  async init(): Promise<void> {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.version);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        this.db = request.result;
        resolve();
      };
      
      request.onupgradeneeded = (event) => {
        const db = (event.target as IDBOpenDBRequest).result;
        if (!db.objectStoreNames.contains('styleExamples')) {
          db.createObjectStore('styleExamples', { keyPath: 'id' });
        }
        if (!db.objectStoreNames.contains('settings')) {
          db.createObjectStore('settings', { keyPath: 'key' });
        }
      };
    });
  }

  async getStyleExamples(): Promise<StyleExample[]> {
    if (!this.db) await this.init();
    return new Promise((resolve, reject) => {
      const transaction = this.db!.transaction(['styleExamples'], 'readonly');
      const store = transaction.objectStore('styleExamples');
      const request = store.getAll();
      
      request.onsuccess = () => resolve(request.result || []);
      request.onerror = () => reject(request.error);
    });
  }

  async saveStyleExample(example: StyleExample): Promise<void> {
    if (!this.db) await this.init();
    return new Promise((resolve, reject) => {
      const transaction = this.db!.transaction(['styleExamples'], 'readwrite');
      const store = transaction.objectStore('styleExamples');
      const request = store.put(example);
      
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }

  async deleteStyleExample(id: string): Promise<void> {
    if (!this.db) await this.init();
    return new Promise((resolve, reject) => {
      const transaction = this.db!.transaction(['styleExamples'], 'readwrite');
      const store = transaction.objectStore('styleExamples');
      const request = store.delete(id);
      
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }

  async getSettings(): Promise<AppSettings | null> {
    if (!this.db) await this.init();
    return new Promise((resolve, reject) => {
      const transaction = this.db!.transaction(['settings'], 'readonly');
      const store = transaction.objectStore('settings');
      const request = store.get('appSettings');
      
      request.onsuccess = () => resolve(request.result?.value || null);
      request.onerror = () => reject(request.error);
    });
  }

  async saveSettings(settings: AppSettings): Promise<void> {
    if (!this.db) await this.init();
    return new Promise((resolve, reject) => {
      const transaction = this.db!.transaction(['settings'], 'readwrite');
      const store = transaction.objectStore('settings');
      const request = store.put({ key: 'appSettings', value: settings });
      
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }

  async exportAll(): Promise<string> {
    const examples = await this.getStyleExamples();
    const settings = await this.getSettings();
    return JSON.stringify({ examples, settings }, null, 2);
  }

  async importAll(jsonData: string): Promise<void> {
    const data = JSON.parse(jsonData);
    if (data.examples) {
      for (const example of data.examples) {
        await this.saveStyleExample(example);
      }
    }
    if (data.settings) {
      await this.saveSettings(data.settings);
    }
  }

  async clearAll(): Promise<void> {
    if (!this.db) await this.init();
    return new Promise((resolve, reject) => {
      const transaction = this.db!.transaction(['styleExamples', 'settings'], 'readwrite');
      const examplesStore = transaction.objectStore('styleExamples');
      const settingsStore = transaction.objectStore('settings');
      
      examplesStore.clear();
      settingsStore.clear();
      
      transaction.oncomplete = () => resolve();
      transaction.onerror = () => reject(transaction.error);
    });
  }
}

const storage = new Storage();

// ============================================================================
// REWRITE ENGINE
// ============================================================================

class RewriteEngine {
  private vocabularyMap: Record<string, string> = {
    'lack of clarity': 'unclear',
    'not consistently': 'inconsistently',
    'at this stage': 'based on current information',
    'in order to': 'to',
    'due to the fact that': 'because',
    'for the purpose of': 'to',
    'with regards to': 'regarding',
    'at the present time': 'currently',
  };

  private fillerPhrases = [
    'We note that',
    'For awareness',
    'It should be noted',
    'It is important to note',
    'Please be advised',
    'For your information',
  ];

  private weakQualifiers = [
    'may',
    'could',
    'potentially',
    'appears to',
    'seems to',
    'generally',
    'possibly',
    'might',
  ];

  rewrite(text: string, options: RewriteOptions, styleExamples: StyleExample[]): RewriteResult {
    const changeLog: Change[] = [];
    const suggestions: string[] = [];
    
    // Normalise whitespace
    let processed = text.trim().replace(/\s+/g, ' ');
    
    // Split into sentences
    const sentences = this.splitSentences(processed);
    const rewrittenSentences: string[] = [];
    
    for (let sentence of sentences) {
      let original = sentence;
      
      // Remove filler openers
      if (options.concise) {
        for (const filler of this.fillerPhrases) {
          const regex = new RegExp(`^${filler}\\s+`, 'i');
          if (regex.test(sentence)) {
            sentence = sentence.replace(regex, '');
            changeLog.push({ type: 'concision', description: `Removed filler: "${filler}"` });
          }
        }
      }
      
      // Replace vocabulary
      for (const [from, to] of Object.entries(this.vocabularyMap)) {
        const regex = new RegExp(from, 'gi');
        if (regex.test(sentence)) {
          sentence = sentence.replace(regex, to);
          changeLog.push({ type: 'clarity', description: `Replaced "${from}" with "${to}"` });
        }
      }
      
      // Remove weak qualifiers (conservatively)
      if (options.calmTone || options.concise) {
        for (const qualifier of this.weakQualifiers) {
          const regex = new RegExp(`\\b${qualifier}\\b`, 'gi');
          if (regex.test(sentence)) {
            const withoutQualifier = sentence.replace(regex, '').replace(/\s+/g, ' ').trim();
            if (this.isSafeToRemoveQualifier(sentence, withoutQualifier)) {
              sentence = withoutQualifier;
              changeLog.push({ type: 'precision', description: `Removed weak qualifier: "${qualifier}"` });
            }
          }
        }
      }
      
      // Convert passive to active
      if (options.activeVoice) {
        const activeResult = this.convertPassiveToActive(sentence, options.owner);
        if (activeResult.converted) {
          sentence = activeResult.sentence;
          changeLog.push({ type: 'voice', description: 'Converted passive to active voice' });
        }
      }
      
      // Add impact if missing and safe
      if (options.sharperImpact) {
        const impactResult = this.addImpact(sentence, options.documentType);
        if (impactResult.added) {
          sentence = impactResult.sentence;
          changeLog.push({ type: 'impact', description: 'Added impact clarification' });
        } else if (impactResult.suggestion) {
          suggestions.push(impactResult.suggestion);
        }
      }
      
      // Apply style examples heuristics
      if (styleExamples.length > 0) {
        sentence = this.applyStyleHeuristics(sentence, styleExamples);
      }
      
      rewrittenSentences.push(sentence);
    }
    
    const rewrittenText = rewrittenSentences.join(' ').trim();
    
    return { rewrittenText, changeLog, suggestions };
  }

  private splitSentences(text: string): string[] {
    return text.match(/[^.!?]+[.!?]+/g)?.map(s => s.trim()) || [text];
  }

  private isSafeToRemoveQualifier(original: string, modified: string): boolean {
    // Conservative: only remove if sentence structure remains sound
    const hasVerb = /\b(is|was|are|were|has|have|had|does|do|did)\b/i.test(modified);
    return hasVerb && modified.length > 10;
  }

  private convertPassiveToActive(sentence: string, owner?: string): { converted: boolean; sentence: string } {
    // Match "X was/were [not] VERB"
    const passivePattern = /(.+)\s+(was|were)\s+(not\s+)?(\w+ed|completed|identified|observed|implemented)/i;
    const match = sentence.match(passivePattern);
    
    if (match && owner) {
      const subject = match[1].trim();
      const negation = match[3] || '';
      const verb = match[4];
      
      const activeVerb = this.passiveToActiveVerb(verb);
      const newSentence = `${owner} ${negation}${activeVerb} ${subject}.`;
      return { converted: true, sentence: newSentence };
    }
    
    return { converted: false, sentence };
  }

  private passiveToActiveVerb(passiveVerb: string): string {
    const map: Record<string, string> = {
      'completed': 'did not complete',
      'identified': 'did not identify',
      'observed': 'did not observe',
      'implemented': 'did not implement',
    };
    return map[passiveVerb.toLowerCase()] || 'did not ' + passiveVerb.replace(/ed$/, '');
  }

  private addImpact(sentence: string, docType: DocumentType): { added: boolean; sentence: string; suggestion?: string } {
    // Only add impact for audit findings if no consequence mentioned
    if (docType === 'audit-finding' && !sentence.includes('risk') && !sentence.includes('impact') && !sentence.includes('result')) {
      if (sentence.includes('control') || sentence.includes('process')) {
        return {
          added: true,
          sentence: sentence.replace(/\.$/, ', which increases operational risk.'),
        };
      } else {
        return {
          added: false,
          sentence,
          suggestion: 'Consider adding impact: what does this lead to?',
        };
      }
    }
    
    return { added: false, sentence };
  }

  private applyStyleHeuristics(sentence: string, examples: StyleExample[]): string {
    const activeExamples = examples.filter(e => e.isActive).slice(0, 3);
    
    // Calculate average sentence length from active examples
    const avgLength = activeExamples.reduce((sum, ex) => {
      const sentences = this.splitSentences(ex.text);
      const avgLen = sentences.reduce((s, sent) => s + sent.split(' ').length, 0) / sentences.length;
      return sum + avgLen;
    }, 0) / (activeExamples.length || 1);
    
    // If current sentence is much longer, consider splitting
    const wordCount = sentence.split(' ').length;
    if (wordCount > avgLength * 1.5 && wordCount > 20) {
      // Simple split at conjunction
      sentence = sentence.replace(/, and /i, '. ').replace(/, which /i, '. This ');
    }
    
    return sentence;
  }
}

const rewriteEngine = new RewriteEngine();

// ============================================================================
// NETWORK GUARD
// ============================================================================

let networkGuardActive = false;

const activateNetworkGuard = () => {
  networkGuardActive = true;
};

const deactivateNetworkGuard = () => {
  networkGuardActive = false;
};

// Monkey-patch fetch
const originalFetch = window.fetch;
window.fetch = function(...args) {
  if (networkGuardActive) {
    throw new Error('Network calls are blocked during rewrite operations');
  }
  return originalFetch.apply(this, args);
};

// ============================================================================
// SAMPLE DATA
// ============================================================================

const sampleInputs: Record<DocumentType, string> = {
  'audit-finding': 'Access reviews for privileged accounts were not consistently completed on a quarterly basis. This may potentially result in unauthorised access remaining undetected.',
  'executive-summary': 'It should be noted that the controls around the vendor onboarding process lack clarity and appear to be generally inconsistent across business units.',
  'status-update': 'For awareness, the remediation activities are progressing, however there could be delays due to resource constraints at this stage.',
  'email-senior': 'We note that the data classification project was not completed as planned and this seems to have impacted downstream initiatives.',
  'risk-description': 'The lack of formal change management procedures may lead to unauthorised modifications which could potentially compromise system integrity.',
};

// ============================================================================
// MAIN APP COMPONENT
// ============================================================================

export default function ClearLine() {
  const [activeTab, setActiveTab] = useState<'rewrite' | 'library' | 'settings'>('rewrite');
  const [inputText, setInputText] = useState('');
  const [outputText, setOutputText] = useState('');
  const [changeLog, setChangeLog] = useState<Change[]>([]);
  const [suggestions, setSuggestions] = useState<string[]>([]);
  const [showChanges, setShowChanges] = useState(false);
  const [copied, setCopied] = useState(false);
  
  const [documentType, setDocumentType] = useState<DocumentType>('audit-finding');
  const [owner, setOwner] = useState('');
  const [options, setOptions] = useState<Omit<RewriteOptions, 'owner' | 'documentType'>>({
    activeVoice: true,
    clearOwnership: true,
    sharperImpact: true,
    calmTone: true,
    concise: true,
  });
  
  const [styleExamples, setStyleExamples] = useState<StyleExample[]>([]);
  const [newExampleTitle, setNewExampleTitle] = useState('');
  const [newExampleText, setNewExampleText] = useState('');
  const [newExampleTags, setNewExampleTags] = useState('');
  const [filterTag, setFilterTag] = useState('');
  
  const [settings, setSettings] = useState<AppSettings>({
    theme: 'system',
    defaultDocType: 'audit-finding',
    defaultToggles: {
      activeVoice: true,
      clearOwnership: true,
      sharperImpact: true,
      calmTone: true,
      concise: true,
    },
  });
  
  const fileInputRef = useRef<HTMLInputElement>(null);
  
  // Load data on mount
  useEffect(() => {
    storage.init().then(async () => {
      const examples = await storage.getStyleExamples();
      setStyleExamples(examples);
      
      const savedSettings = await storage.getSettings();
      if (savedSettings) {
        setSettings(savedSettings);
        setDocumentType(savedSettings.defaultDocType);
        setOptions(savedSettings.defaultToggles);
      }
    });
  }, []);
  
  // Apply theme
  useEffect(() => {
    const root = document.documentElement;
    if (settings.theme === 'dark') {
      root.classList.add('dark');
    } else if (settings.theme === 'light') {
      root.classList.remove('dark');
    } else {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (prefersDark) root.classList.add('dark');
      else root.classList.remove('dark');
    }
  }, [settings.theme]);
  
  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        handleRewrite();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.querySelector<HTMLTextAreaElement>('#input-text')?.focus();
      }
    };
    
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [inputText, documentType, owner, options, styleExamples]);
  
  const handleRewrite = () => {
    if (!inputText.trim()) return;
    
    activateNetworkGuard();
    
    try {
      const result = rewriteEngine.rewrite(inputText, {
        ...options,
        owner: owner.trim() || undefined,
        documentType,
      }, styleExamples);
      
      setOutputText(result.rewrittenText);
      setChangeLog(result.changeLog);
      setSuggestions(result.suggestions);
      setShowChanges(false);
    } finally {
      deactivateNetworkGuard();
    }
  };
  
  const handleCopy = (text: string) => {
    navigator.clipboard.writeText(text);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };
  
  const handleLoadSample = (type: DocumentType) => {
    setInputText(sampleInputs[type]);
    setDocumentType(type);
  };
  
  const handleAddExample = async () => {
    if (!newExampleTitle.trim() || !newExampleText.trim()) return;
    
    const example: StyleExample = {
      id: Date.now().toString(),
      title: newExampleTitle,
      text: newExampleText,
      tags: newExampleTags.split(',').map(t => t.trim()).filter(Boolean),
      isActive: false,
    };
    
    await storage.saveStyleExample(example);
    const examples = await storage.getStyleExamples();
    setStyleExamples(examples);
    
    setNewExampleTitle('');
    setNewExampleText('');
    setNewExampleTags('');
  };
  
  const handleToggleActive = async (id: string) => {
    const example = styleExamples.find(e => e.id === id);
    if (!example) return;
    
    const activeCount = styleExamples.filter(e => e.isActive).length;
    if (!example.isActive && activeCount >= 3) {
      alert('Maximum 3 active style anchors allowed');
      return;
    }
    
    example.isActive = !example.isActive;
    await storage.saveStyleExample(example);
    const examples = await storage.getStyleExamples();
    setStyleExamples(examples);
  };
  
  const handleDeleteExample = async (id: string) => {
    if (!confirm('Delete this style example?')) return;
    await storage.deleteStyleExample(id);
    const examples = await storage.getStyleExamples();
    setStyleExamples(examples);
  };
  
  const handleExport = async () => {
    const data = await storage.exportAll();
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `clearline-export-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };
  
  const handleImport = () => {
    fileInputRef.current?.click();
  };
  
  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    const text = await file.text();
    try {
      await storage.importAll(text);
      const examples = await storage.getStyleExamples();
      setStyleExamples(examples);
      const savedSettings = await storage.getSettings();
      if (savedSettings) setSettings(savedSettings);
      alert('Data imported successfully');
    } catch (err) {
      alert('Import failed: invalid file format');
    }
  };
  
  const handleClearAll = async () => {
    if (!confirm('Delete ALL data? This cannot be undone.')) return;
    if (!confirm('Are you absolutely sure? All style examples and settings will be permanently deleted.')) return;
    
    await storage.clearAll();
    setStyleExamples([]);
    setSettings({
      theme: 'system',
      defaultDocType: 'audit-finding',
      defaultToggles: {
        activeVoice: true,
        clearOwnership: true,
        sharperImpact: true,
        calmTone: true,
        concise: true,
      },
    });
  };
  
  const handleSaveSettings = async () => {
    await storage.saveSettings(settings);
    alert('Settings saved');
  };
  
  const filteredExamples = filterTag
    ? styleExamples.filter(e => e.tags.includes(filterTag))
    : styleExamples;
  
  const allTags = Array.from(new Set(styleExamples.flatMap(e => e.tags)));
  
  return (
    <div className="app">
      <header className="header">
        <h1>ClearLine</h1>
        <p className="tagline">Audit text rewriter · Local-only · Private</p>
      </header>
      
      <nav className="nav">
        <button
          className={`nav-btn ${activeTab === 'rewrite' ? 'active' : ''}`}
          onClick={() => setActiveTab('rewrite')}
        >
          <FileText size={20} />
          <span>Rewrite</span>
        </button>
        <button
          className={`nav-btn ${activeTab === 'library' ? 'active' : ''}`}
          onClick={() => setActiveTab('library')}
        >
          <BookOpen size={20} />
          <span>Style Library</span>
        </button>
        <button
          className={`nav-btn ${activeTab === 'settings' ? 'active' : ''}`}
          onClick={() => setActiveTab('settings')}
        >
          <Settings size={20} />
          <span>Settings</span>
        </button>
      </nav>
      
      <main className="main">
        {activeTab === 'rewrite' && (
          <div className="rewrite-tab">
            <div className="card">
              <div className="card-header">
                <h2>Input</h2>
                <select
                  value={documentType}
                  onChange={(e) => setDocumentType(e.target.value as DocumentType)}
                  className="select"
                >
                  <option value="audit-finding">Audit finding</option>
                  <option value="executive-summary">Executive summary</option>
                  <option value="status-update">Status update</option>
                  <option value="email-senior">Email to senior management</option>
                  <option value="risk-description">Risk description</option>
                </select>
              </div>
              
              <textarea
                id="input-text"
                className="textarea"
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                placeholder="Enter text to rewrite..."
                rows={6}
              />
              
              <div className="meta">
                <span>{inputText.length} characters</span>
                <select
                  className="select-small"
                  onChange={(e) => e.target.value && handleLoadSample(e.target.value as DocumentType)}
                  value=""
                >
                  <option value="">Load sample...</option>
                  <option value="audit-finding">Audit finding</option>
                  <option value="executive-summary">Executive summary</option>
                  <option value="status-update">Status update</option>
                  <option value="email-senior">Email to senior</option>
                  <option value="risk-description">Risk description</option>
                </select>
              </div>
              
              <div className="field">
                <label>Owner / Function (optional)</label>
                <input
                  type="text"
                  className="input"
                  value={owner}
                  onChange={(e) => setOwner(e.target.value)}
                  placeholder="e.g., Operations, Access Management Team"
                />
              </div>
              
              <div className="toggles">
                <label className="toggle">
                  <input
                    type="checkbox"
                    checked={options.activeVoice}
                    onChange={(e) => setOptions({ ...options, activeVoice: e.target.checked })}
                  />
                  <span>Active voice</span>
                </label>
                <label className="toggle">
                  <input
                    type="checkbox"
                    checked={options.clearOwnership}
                    onChange={(e) => setOptions({ ...options, clearOwnership: e.target.checked })}
                  />
                  <span>Clear ownership</span>
                </label>
                <label className="toggle">
                  <input
                    type="checkbox"
                    checked={options.sharperImpact}
                    onChange={(e) => setOptions({ ...options, sharperImpact: e.target.checked })}
                  />
                  <span>Sharper impact</span>
                </label>
                <label className="toggle">
                  <input
                    type="checkbox"
                    checked={options.calmTone}
                    onChange={(e) => setOptions({ ...options, calmTone: e.target.checked })}
                  />
                  <span>Calm / non-alarmist</span>
                </label>
                <label className="toggle">
                  <input
                    type="checkbox"
                    checked={options.concise}
                    onChange={(e) => setOptions({ ...options, concise: e.target.checked })}
                  />
                  <span>Concise</span>
                </label>
              </div>
              
              <button className="btn-primary" onClick={handleRewrite}>
                <RefreshCw size={18} />
                Rewrite
              </button>
            </div>
            
            {outputText && (
              <div className="card">
                <div className="card-header">
                  <h2>Output</h2>
                  <div className="actions">
                    <button className="btn-secondary" onClick={() => setShowChanges(!showChanges)}>
                      {showChanges ? 'Hide' : 'Show'} changes
                    </button>
                    <button className="btn-secondary" onClick={() => handleCopy(outputText)}>
                      {copied ? <Check size={18} /> : <Copy size={18} />}
                      {copied ? 'Copied' : 'Copy'}
                    </button>
                  </div>
                </div>
                
                <div className="output-text">{outputText}</div>
                
                {showChanges && changeLog.length > 0 && (
                  <div className="changes">
                    <h3>Changes made:</h3>
                    <ul>
                      {changeLog.map((change, i) => (
                        <li key={i}>
                          <strong>{change.type}:</strong> {change.description}
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
                
                {suggestions.length > 0 && (
                  <div className="suggestions">
                    <h3>Suggestions:</h3>
                    <ul>
                      {suggestions.map((sug, i) => (
                        <li key={i}>{sug}</li>
                      ))}
                    </ul>
                  </div>
                )}
                
                <div className="actions">
                  <button className="btn-secondary" onClick={() => setInputText(outputText)}>
                    Replace input with output
                  </button>
                  <button className="btn-secondary" onClick={() => { setInputText(''); setOutputText(''); }}>
                    Clear all
                  </button>
                </div>
              </div>
            )}
          </div>
        )}
        
        {activeTab === 'library' && (
          <div className="library-tab">
            <div className="card">
              <h2>Add Style Example</h2>
              <div className="field">
                <label>Title</label>
                <input
                  type="text"
                  className="input"
                  value={newExampleTitle}
                  onChange={(e) => setNewExampleTitle(e.target.value)}
                  placeholder="e.g., Clear audit finding"
                />
              </div>
              <div className="field">
                <label>Text</label>
                <textarea
                  className="textarea"
                  value={newExampleText}
                  onChange={(e) => setNewExampleText(e.target.value)}
                  placeholder="Paste an example of your preferred writing style"
                  rows={4}
                />
              </div>
              <div className="field">
                <label>Tags (comma-separated)</label>
                <input
                  type="text"
                  className="input"
                  value={newExampleTags}
                  onChange={(e) => setNewExampleTags(e.target.value)}
                  placeholder="e.g., firm, calm, exec, short"
                />
              </div>
              <button className="btn-primary" onClick={handleAddExample}>
                Add Example
              </button>
            </div>
            
            <div className="card">
              <div className="card-header">
                <h2>Style Examples</h2>
                <select
                  className="select-small"
                  value={filterTag}
                  onChange={(e) => setFilterTag(e.target.value)}
                >
                  <option value="">All tags</option>
                  {allTags.map(tag => (
                    <option key={tag} value={tag}>{tag}</option>
                  ))}
                </select>
              </div>
              
              {filteredExamples.length === 0 ? (
                <p className="empty">No style examples yet. Add your first example above.</p>
              ) : (
                <div className="examples-list">
                  {filteredExamples.map(example => (
                    <div key={example.id} className={`example-item ${example.isActive ? 'active' : ''}`}>
                      <div className="example-header">
                        <h3>{example.title}</h3>
                        <div className="example-actions">
                          <button
                            className="btn-icon"
                            onClick={() => handleToggleActive(example.id)}
                            title={example.isActive ? 'Deactivate' : 'Activate as style anchor'}
                          >
                            {example.isActive ? '★' : '☆'}
                          </button>
                          <button
                            className="btn-icon"
                            onClick={() => handleDeleteExample(example.id)}
                            title="Delete"
                          >
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                      <p className="example-text">{example.text}</p>
                      {example.tags.length > 0 && (
                        <div className="tags">
                          {example.tags.map(tag => (
                            <span key={tag} className="tag">{tag}</span>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
              
              <div className="info-box">
                <strong>Active Style Anchors:</strong> {styleExamples.filter(e => e.isActive).length} / 3
                <br />
                <small>Active examples influence rewrite style (sentence length, preferred phrases).</small>
              </div>
            </div>
          </div>
        )}
        
        {activeTab === 'settings' && (
          <div className="settings-tab">
            <div className="card">
              <h2>Appearance</h2>
              <div className="field">
                <label>Theme</label>
                <div className="theme-buttons">
                  <button
                    className={`btn-icon-text ${settings.theme === 'light' ? 'active' : ''}`}
                    onClick={() => setSettings({ ...settings, theme: 'light' })}
                  >
                    <Sun size={18} />
                    Light
                  </button>
                  <button
                    className={`btn-icon-text ${settings.theme === 'dark' ? 'active' : ''}`}
                    onClick={() => setSettings({ ...settings, theme: 'dark' })}
                  >
                    <Moon size={18} />
                    Dark
                  </button>
                  <button
                    className={`btn-icon-text ${settings.theme === 'system' ? 'active' : ''}`}
                    onClick={() => setSettings({ ...settings, theme: 'system' })}
                  >
                    <Monitor size={18} />
                    System
                  </button>
                </div>
              </div>
            </div>
            
            <div className="card">
              <h2>Defaults</h2>
              <div className="field">
                <label>Default Document Type</label>
                <select
                  className="select"
                  value={settings.defaultDocType}
                  onChange={(e) => setSettings({ ...settings, defaultDocType: e.target.value as DocumentType })}
                >
                  <option value="audit-finding">Audit finding</option>
                  <option value="executive-summary">Executive summary</option>
                  <option value="status-update">Status update</option>
                  <option value="email-senior">Email to senior management</option>
                  <option value="risk-description">Risk description</option>
                </select>
              </div>
              
              <div className="field">
                <label>Default Toggles</label>
                <div className="toggles">
                  <label className="toggle">
                    <input
                      type="checkbox"
                      checked={settings.defaultToggles.activeVoice}
                      onChange={(e) => setSettings({
                        ...settings,
                        defaultToggles: { ...settings.defaultToggles, activeVoice: e.target.checked }
                      })}
                    />
                    <span>Active voice</span>
                  </label>
                  <label className="toggle">
                    <input
                      type="checkbox"
                      checked={settings.defaultToggles.clearOwnership}
                      onChange={(e) => setSettings({
                        ...settings,
                        defaultToggles: { ...settings.defaultToggles, clearOwnership: e.target.checked }
                      })}
                    />
                    <span>Clear ownership</span>
                  </label>
                  <label className="toggle">
                    <input
                      type="checkbox"
                      checked={settings.defaultToggles.sharperImpact}
                      onChange={(e) => setSettings({
                        ...settings,
                        defaultToggles: { ...settings.defaultToggles, sharperImpact: e.target.checked }
                      })}
                    />
                    <span>Sharper impact</span>
                  </label>
                  <label className="toggle">
                    <input
                      type="checkbox"
                      checked={settings.defaultToggles.calmTone}
                      onChange={(e) => setSettings({
                        ...settings,
                        defaultToggles: { ...settings.defaultToggles, calmTone: e.target.checked }
                      })}
                    />
                    <span>Calm / non-alarmist</span>
                  </label>
                  <label className="toggle">
                    <input
                      type="checkbox"
                      checked={settings.defaultToggles.concise}
                      onChange={(e) => setSettings({
                        ...settings,
                        defaultToggles: { ...settings.defaultToggles, concise: e.target.checked }
                      })}
                    />
                    <span>Concise</span>
                  </label>
                </div>
              </div>
              
              <button className="btn-primary" onClick={handleSaveSettings}>
                Save Settings
              </button>
            </div>
            
            <div className="card">
              <h2>Data Management</h2>
              <div className="data-actions">
                <button className="btn-secondary" onClick={handleExport}>
                  <Download size={18} />
                  Export All Data
                </button>
                <button className="btn-secondary" onClick={handleImport}>
                  <Upload size={18} />
                  Import Data
                </button>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="application/json"
                  style={{ display: 'none' }}
                  onChange={handleFileChange}
                />
                <button className="btn-danger" onClick={handleClearAll}>
                  <Trash2 size={18} />
                  Delete All Data
                </button>
              </div>
            </div>
            
            <div className="card privacy-card">
              <h2>Privacy Statement</h2>
              <p>
                <strong>ClearLine works entirely on your device.</strong> No text is sent anywhere.
                All rewriting happens locally in your browser using deterministic rules.
              </p>
              <p className="technical-note">
                <strong>Technical guarantee:</strong> No network calls are made during rewrite operations.
                The rewrite engine is blocked from accessing the network via a network guard.
                All data is stored in your browser's IndexedDB and never leaves your device.
              </p>
              <p>
                Your style examples, settings, and all text you enter remain private and under your control.
                You can export, import, or delete all data at any time.
              </p>
            </div>
          </div>
        )}
      </main>
      
      <style>{`
        :root {
          --bg: #ffffff;
          --surface: #f8f9fa;
          --border: #e1e4e8;
          --text: #24292e;
          --text-secondary: #586069;
          --primary: #0366d6;
          --primary-hover: #0256c0;
          --danger: #d73a49;
          --success: #28a745;
          --radius: 8px;
          --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .dark {
          --bg: #0d1117;
          --surface: #161b22;
          --border: #30363d;
          --text: #c9d1d9;
          --text-secondary: #8b949e;
          --primary: #58a6ff;
          --primary-hover: #4493e8;
        }
        
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }
        
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica', sans-serif;
          background: var(--bg);
          color: var(--text);
          line-height: 1.6;
        }
        
        .app {
          min-height: 100vh;
          display: flex;
          flex-direction: column;
          max-width: 1200px;
          margin: 0 auto;
          padding-bottom: 80px;
        }
        
        .header {
          padding: 2rem 1rem 1rem;
          text-align: center;
          border-bottom: 1px solid var(--border);
        }
        
        .header h1 {
          font-size: 2rem;
          font-weight: 600;
          margin-bottom: 0.25rem;
        }
        
        .tagline {
          color: var(--text-secondary);
          font-size: 0.875rem;
        }
        
        .nav {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: var(--surface);
          border-top: 1px solid var(--border);
          display: flex;
          justify-content: space-around;
          padding: 0.5rem;
          z-index: 100;
        }
        
        .nav-btn {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 0.25rem;
          padding: 0.5rem 1rem;
          background: none;
          border: none;
          color: var(--text-secondary);
          cursor: pointer;
          border-radius: var(--radius);
          font-size: 0.75rem;
          transition: all 0.2s;
        }
        
        .nav-btn:hover {
          background: var(--bg);
        }
        
        .nav-btn.active {
          color: var(--primary);
          background: var(--bg);
        }
        
        .main {
          flex: 1;
          padding: 1.5rem 1rem;
        }
        
        .card {
          background: var(--surface);
          border: 1px solid var(--border);
          border-radius: var(--radius);
          padding: 1.5rem;
          margin-bottom: 1.5rem;
          box-shadow: var(--shadow);
        }
        
        .card h2 {
          font-size: 1.25rem;
          font-weight: 600;
          margin-bottom: 1rem;
        }
        
        .card h3 {
          font-size: 1rem;
          font-weight: 600;
          margin: 1rem 0 0.5rem;
        }
        
        .card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
        }
        
        .card-header h2 {
          margin: 0;
        }
        
        .textarea {
          width: 100%;
          padding: 0.75rem;
          border: 1px solid var(--border);
          border-radius: var(--radius);
          background: var(--bg);
          color: var(--text);
          font-family: inherit;
          font-size: 0.9375rem;
          resize: vertical;
          margin-bottom: 0.75rem;
        }
        
        .textarea:focus {
          outline: none;
          border-color: var(--primary);
        }
        
        .input {
          width: 100%;
          padding: 0.75rem;
          border: 1px solid var(--border);
          border-radius: var(--radius);
          background: var(--bg);
          color: var(--text);
          font-family: inherit;
          font-size: 0.9375rem;
        }
        
        .input:focus {
          outline: none;
          border-color: var(--primary);
        }
        
        .select, .select-small {
          padding: 0.5rem;
          border: 1px solid var(--border);
          border-radius: var(--radius);
          background: var(--bg);
          color: var(--text);
          font-family: inherit;
          cursor: pointer;
        }
        
        .select-small {
          font-size: 0.875rem;
        }
        
        .meta {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
          font-size: 0.875rem;
          color: var(--text-secondary);
        }
        
        .field {
          margin-bottom: 1rem;
        }
        
        .field label {
          display: block;
          font-weight: 500;
          margin-bottom: 0.5rem;
          font-size: 0.9375rem;
        }
        
        .toggles {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 0.75rem;
          margin-bottom: 1rem;
        }
        
        .toggle {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          cursor: pointer;
          user-select: none;
        }
        
        .toggle input[type="checkbox"] {
          width: 18px;
          height: 18px;
          cursor: pointer;
        }
        
        .btn-primary {
          width: 100%;
          padding: 0.75rem;
          background: var(--primary);
          color: white;
          border: none;
          border-radius: var(--radius);
          font-weight: 600;
          font-size: 1rem;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 0.5rem;
          transition: background 0.2s;
        }
        
        .btn-primary:hover {
          background: var(--primary-hover);
        }
        
        .btn-secondary {
          padding: 0.5rem 1rem;
          background: var(--bg);
          color: var(--text);
          border: 1px solid var(--border);
          border-radius: var(--radius);
          font-size: 0.875rem;
          cursor: pointer;
          display: inline-flex;
          align-items: center;
          gap: 0.5rem;
          transition: all 0.2s;
        }
        
        .btn-secondary:hover {
          border-color: var(--primary);
          color: var(--primary);
        }
        
        .btn-danger {
          padding: 0.5rem 1rem;
          background: var(--danger);
          color: white;
          border: none;
          border-radius: var(--radius);
          font-size: 0.875rem;
          cursor: pointer;
          display: inline-flex;
          align-items: center;
          gap: 0.5rem;
          transition: opacity 0.2s;
        }
        
        .btn-danger:hover {
          opacity: 0.9;
        }
        
        .btn-icon {
          background: none;
          border: none;
          color: var(--text-secondary);
          cursor: pointer;
          padding: 0.25rem;
          font-size: 1.25rem;
          transition: color 0.2s;
        }
        
        .btn-icon:hover {
          color: var(--primary);
        }
        
        .btn-icon-text {
          padding: 0.75rem 1rem;
          background: var(--bg);
          color: var(--text);
          border: 1px solid var(--border);
          border-radius: var(--radius);
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 0.5rem;
          transition: all 0.2s;
        }
        
        .btn-icon-text.active {
          border-color: var(--primary);
          background: var(--primary);
          color: white;
        }
        
        .actions {
          display: flex;
          gap: 0.5rem;
          flex-wrap: wrap;
          margin-top: 1rem;
        }
        
        .output-text {
          padding: 1rem;
          background: var(--bg);
          border: 1px solid var(--border);
          border-radius: var(--radius);
          line-height: 1.7;
          margin-bottom: 1rem;
        }
        
        .changes, .suggestions {
          padding: 1rem;
          background: var(--bg);
          border: 1px solid var(--border);
          border-radius: var(--radius);
          margin-bottom: 1rem;
        }
        
        .changes ul, .suggestions ul {
          list-style: none;
          padding-left: 0;
        }
        
        .changes li, .suggestions li {
          padding: 0.5rem 0;
          border-bottom: 1px solid var(--border);
        }
        
        .changes li:last-child, .suggestions li:last-child {
          border-bottom: none;
        }
        
        .empty {
          text-align: center;
          color: var(--text-secondary);
          padding: 2rem;
        }
        
        .examples-list {
          display: flex;
          flex-direction: column;
          gap: 1rem;
          margin-bottom: 1rem;
        }
        
        .example-item {
          padding: 1rem;
          background: var(--bg);
          border: 1px solid var(--border);
          border-radius: var(--radius);
        }
        
        .example-item.active {
          border-color: var(--primary);
          background: var(--bg);
        }
        
        .example-header {
          display: flex;
          justify-content: space-between;
          align-items: start;
          margin-bottom: 0.5rem;
        }
        
        .example-header h3 {
          margin: 0;
        }
        
        .example-actions {
          display: flex;
          gap: 0.5rem;
        }
        
        .example-text {
          color: var(--text-secondary);
          font-size: 0.9375rem;
          margin-bottom: 0.5rem;
        }
        
        .tags {
          display: flex;
          gap: 0.5rem;
          flex-wrap: wrap;
        }
        
        .tag {
          padding: 0.25rem 0.5rem;
          background: var(--primary);
          color: white;
          border-radius: 4px;
          font-size: 0.75rem;
        }
        
        .info-box {
          padding: 1rem;
          background: var(--bg);
          border: 1px solid var(--border);
          border-radius: var(--radius);
          font-size: 0.875rem;
          line-height: 1.6;
        }
        
        .theme-buttons {
          display: flex;
          gap: 0.5rem;
        }
        
        .data-actions {
          display: flex;
          flex-direction: column;
          gap: 0.75rem;
        }
        
        .privacy-card p {
          margin-bottom: 1rem;
        }
        
        .privacy-card p:last-child {
          margin-bottom: 0;
        }
        
        .technical-note {
          padding: 0.75rem;
          background: var(--bg);
          border-left: 3px solid var(--primary);
          border-radius: 4px;
          font-size: 0.875rem;
        }
        
        @media (min-width: 768px) {
          .nav {
            position: static;
            border-top: none;
            border-bottom: 1px solid var(--border);
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
          }
          
          .nav-btn {
            flex-direction: row;
            font-size: 0.9375rem;
          }
          
          .app {
            padding-bottom: 2rem;
          }
          
          .main {
            padding: 2rem;
          }
          
          .theme-buttons {
            max-width: 500px;
          }
          
          .data-actions {
            max-width: 500px;
          }
        }
      `}</style>
    </div>
  );
}
